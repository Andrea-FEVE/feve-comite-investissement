<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Projet</title>
  <style>
    body {
      font-family: system-ui;
      background: #f7f8fa;
      padding: 40px;
    }

    .page {
      max-width: 920px;
      margin: 0 auto;
      background: white;
      padding: 24px;
      border-radius: 8px;
    }

    img {
      width: 100%;
      max-height: 360px;
      object-fit: cover;
      border-radius: 6px;
      margin: 16px 0;
    }

    h1 {
      margin-bottom: 8px;
    }

    .meta {
      color: #666;
      margin-bottom: 12px;
    }

    .section {
      margin-top: 24px;
    }

  label {
  display: block;
  margin-bottom: 20px;
}

textarea {
  width: 100%;
  min-height: 100px;
  margin-top: 6px;
}

.tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 8px;
}

.tags span {
  padding: 6px 14px;
  border-radius: 50px;
  border: 1px solid;
  cursor: pointer;
  font-size: 14px;
  background: white;
  transition: all 0.15s ease;
}

/* Colors (border by default) */
.tags span.yes {
  border-color: #2e7d32;
  color: #2e7d32;
}

.tags span.no {
  border-color: #c62828;
  color: #c62828;
}

.tags span.conditional {
  border-color: #ef6c00;
  color: #ef6c00;
}

.tags span.neutral {
  border-color: #555;
  color: #555;
}

/* Active = filled */
.tags span.active.yes {
  background: #2e7d32;
  color: white;
}

.tags span.active.no {
  background: #c62828;
  color: white;
}

.tags span.active.conditional {
  background: #ef6c00;
  color: white;
}

.tags span.active.neutral {
  background: #555;
  color: white;
}


button {
  padding: 10px 16px;
  border: none;
  background: #333;
  color: white;
  border-radius: 6px;
  cursor: pointer;
}

  </style>
</head>
<body>

<div class="page" id="project"></div>
  <div id="userGreeting" style="margin-bottom:16px;font-weight:500"></div>

<a href="index.html" style="
  display: inline-block;
  margin-bottom: 16px;
  text-decoration: none;
  color: #555;
  font-size: 14px;
">
‚Üê Retour √† tous les projets
</a>
<script>
  console.log("üîÑ Fetching member info...");

  fetch("/api/member")
    .then(r => {
      console.log("üì° /api/member status:", r.status);
      return r.json();
    })
    .then(member => {
      console.log("‚úÖ Member loaded:", member);
      document.getElementById("userGreeting").textContent =
        `Bonjour ${member.fullName}`;

      // store globally for forms
      window.currentMember = member;
    })
    .catch(err => {
      console.error("‚ùå Failed to load member:", err);
    });
</script>

<script>
  function valueOrDefault(value) {
  if (value === null || value === undefined || value === "") {
    return "Non renseign√©";
  }
  return value;
}

  
  const params = new URLSearchParams(window.location.search);
  const slug = params.get("slug");

  fetch(`/api/project?slug=${slug}`)
    .then(r => r.json())
    .then(p => {
      document.getElementById("project").innerHTML = `
        <h1>${valueOrDefault(p.name)}</h1>
        <div class="meta">${valueOrDefault(p.department)} ¬∑ ${p.dateComite}</div>

        ${p.photo ? `<img src="${p.photo}" />` : ""}

        <div class="section">
          <strong>Nom des porteurs de projets</strong><br>
          ${valueOrDefault(p.porteurs)}
        </div>

        <div class="section">
          <strong>Surface de la ferme</strong><br>
          ${p.surface ? p.surface + " ha" : "‚Äî"}
        </div>

        <div class="section">
          <strong>Montant</strong><br>
          ${p.montant ? p.montant + " ‚Ç¨" : "‚Äî"}
        </div>

        <div class="section">
          <strong>Lien vers le parcellaire</strong><br>
          ${
            p.parcellaire
              ? `<a href="${valueOrDefault(p.parcellaire)}" target="_blank">Voir le parcellaire</a>`
              : "‚Äî"
          }
        </div>

        <div class="section">
          <strong>Description</strong><br>
          <p>${valueOrDefault(p.description)}</p>
        </div>

        <div class="section">
          <h2>Votre avis sur le projet</h2>
          <div class="section">
  <h2>Votre avis sur le projet</h2>

  <form id="reviewForm">
    <input type="hidden" name="user" id="userField">
    <input type="hidden" name="dateComite" id="dateComiteField">

    <label>
      üó®Ô∏èQue pensez-vous de l'opportunit√© d'investissement dans cette ferme vis √† vis de la mission de la fonci√®re ?
      <textarea name="opportunite" required></textarea>
    </label>

    <label>
      Compte tenu des caract√©ristiques et du prix de la ferme, consid√©rez-vous qu'il y ait un risque s'il devait y avoir revente dans 7 √† 10 ans ?
      <div class="tags" data-name="risque">
        <span data-value="Fort" class="no">Fort</span>
        <span data-value="Moyen" class="neutral">Moyen</span>
        <span data-value="Faible" class="yes">Faible</span>
      </div>
    </label>

    <label>
      A quel point serait-il facile ou difficile de trouver un autre locataire en cas de d√©faut du/des PP envisag√©s ?
      <div class="tags" data-name="locataire">
        <span data-value="Facile" class="yes">Facile</span>
        <span data-value="Mod√©r√©ment facile" class="yes">Mod√©r√©ment facile</span>
        <span data-value="Mod√©r√©ment difficile" class="neutral">Mod√©r√©ment difficile</span>
        <span data-value="Difficile" class="no">Difficile</span>
        <span data-value="Tr√®s difficile" class="no">Tr√®s difficile</span>
      </div>
    </label>

    <label>
      Compte tenu des √©l√©ments communiqu√©s, pensez-vous que LES FEVES doivent investir dans cette ferme ?
      <div class="tags" data-name="decision">
        <span data-value="Oui" class="yes">Oui</span>
        <span data-value="Oui avec des conditions suspensives" class="conditional">Oui avec conditions</span>
        <span data-value="Non" class="no">Non</span>
      </div>
    </label>

    <label id="conditionsField" style="display:none">
      üó®Ô∏èPr√©cisez vos √©ventuelles conditions suspensives √† l'acquisition
      <textarea name="conditions"></textarea>
    </label>

    <label>
      üó®Ô∏èDonnez ici votre avis g√©n√©ral sur la ferme, le projet ou posez vos questions
      <textarea name="avis"></textarea>
    </label>

    <button type="submit">Envoyer mon avis</button>
  </form>
</div>

        </div>
      `;
    });

  const cookies = Object.fromEntries(
  document.cookie.split("; ").map(c => c.split("="))
);

document.getElementById("userField").value =
  decodeURIComponent(cookies.user || "Inconnu");

function setupTags() {
  document.querySelectorAll(".tags").forEach(group => {
    console.log("üéØ Tag group found:", group.dataset.name);

    group.addEventListener("click", e => {
      if (e.target.tagName !== "SPAN") return;

      console.log(
        "üñ±Ô∏è Click on",
        group.dataset.name,
        e.target.dataset.value
      );

      group.querySelectorAll("span").forEach(s => {
        s.classList.remove("active");
      });

      e.target.classList.add("active");
      group.dataset.value = e.target.dataset.value;

      console.log(
        "‚úÖ Selected value:",
        group.dataset.name,
        group.dataset.value
      );

      if (group.dataset.name === "decision") {
        const show =
          e.target.dataset.value.includes("conditions");
        document.getElementById("conditionsField").style.display =
          show ? "block" : "none";

        console.log("üìå Conditions field:", show ? "shown" : "hidden");
      }
    });
  });
}

setupTags();


</script>

</body>
</html>
